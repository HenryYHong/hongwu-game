{% extends "base.html" %} {% block title %}Play Hong Wu - Game Interface{%
endblock %} {% block extra_css %}
<style>
  .game-container {
    min-height: 80vh;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
  }

  .player-area {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    backdrop-filter: blur(10px);
  }

  .card {
    display: inline-block;
    width: 60px;
    height: 80px;
    background: white;
    border: 2px solid #333;
    border-radius: 8px;
    margin: 2px;
    text-align: center;
    line-height: 80px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }

  .card.selected {
    transform: translateY(-10px);
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.4);
    border-color: #dc3545;
  }

  .card-back {
    background: url("/static/images/redcard.png") !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .card.hearts {
    color: #dc3545;
  }
  .card.diamonds {
    color: #dc3545;
  }
  .card.clubs {
    color: #000;
  }
  .card.spades {
    color: #000;
  }

  .game-info {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
  }

  .play-area {
    min-height: 120px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px dashed rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
    flex-direction: column;
  }

  .controls {
    text-align: center;
    margin: 20px 0;
  }

  .btn-game {
    margin: 5px;
    min-width: 120px;
  }

  .game-status {
    font-size: 1.2em;
    font-weight: bold;
    color: white;
    text-align: center;
    margin: 10px 0;
  }

  .player-info {
    color: white;
    font-weight: bold;
  }

  .current-player {
    background: rgba(255, 255, 0, 0.3) !important;
    border: 2px solid #ffc107;
  }

  .winner {
    background: rgba(40, 167, 69, 0.3) !important;
    border: 2px solid #28a745;
  }

  .ai-play {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    margin: 5px 0;
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .setup-card {
    background: linear-gradient(135deg, #f7dc6f 0%, #b8860b 50%, #f7dc6f 100%);
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 100%;
    margin: 0;
  }

  .setup-card:hover {
    transform: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .setup-card .card-body {
    padding: 2rem;
  }

  .setup-card h3 {
    color: white;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .form-label {
    color: black;
    font-weight: 600;
  }

  .form-select,
  .form-check-input {
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .btn-start {
    background: linear-gradient(45deg, #c41e3a, #a01830);
    border: none;
    border-radius: 25px;
    padding: 12px 30px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    color: white;
  }

  .btn-start:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(196, 30, 58, 0.4);
    background: linear-gradient(45deg, #a01830, #8b1538);
  }

  .full-width-section {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    padding: 0 20px;
  }

  .form-check.form-switch {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-check-input {
    margin-right: 0;
  }
</style>
{% endblock %} {% block content %}
<div class="full-width-section">
  <!-- Game Setup Section -->
  <div class="row">
    <div class="col-12">
      <div class="card setup-card mb-4">
        <div class="card-body">
          <h3>Start a New Game</h3>
          <div class="row">
            <div class="col-md-6">
              <label for="playerCount" class="form-label">
                <i class="fas fa-users me-2"></i>Number of Players:
              </label>
              <select class="form-select" id="playerCount">
                <option value="3">3 Players</option>
                <option value="4" selected>4 Players</option>
                <option value="5">5 Players</option>
              </select>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="humanToggle"
                  checked
                />
                <label class="form-check-label" for="humanToggle">
                  <i class="fas fa-user me-2"></i>Play as Human (Player 0)
                </label>
              </div>
            </div>
          </div>
          <div class="text-center mt-4">
            <button class="btn btn-start btn-lg" onclick="startGame()">
              <i class="fas fa-rocket me-2"></i>Start Game
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <!-- Game Interface -->
  <div class="row">
    <div class="col-12">
      <div class="game-container">
        <div id="game-interface" style="display: none">
          <div class="game-status" id="game-status">Game in progress...</div>

          <!-- Other Players -->
          <div id="other-players"></div>

          <!-- Play Area -->
          <div class="play-area" id="play-area">
            <div class="text-white">Play area - cards will appear here</div>
          </div>

          <!-- Current Player's Hand -->
          <div class="player-area" id="current-player">
            <h5 class="player-info">Your Hand:</h5>
            <div id="player-hand"></div>
          </div>

          <!-- Game Controls -->
          <div class="controls" id="game-controls">
            <button
              class="btn btn-success btn-game"
              onclick="playCards()"
              id="play-btn"
            >
              <i class="fas fa-play me-2"></i>Play
            </button>
            <button
              class="btn btn-warning btn-game"
              onclick="passTurn()"
              id="pass-btn"
            >
              <i class="fas fa-times me-2"></i>Pass
            </button>
          </div>

          <!-- Game Info -->
          <div class="game-info" id="game-info">
            <div class="row">
              <div class="col-md-6">
                <strong>Current Player:</strong>
                <span id="current-player-id">-</span>
              </div>
              <div class="col-md-6">
                <strong>Deck Size:</strong> <span id="deck-count">0</span> cards
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <strong>Passes:</strong> <span id="passes-count">0</span>
              </div>
              <div class="col-md-6">
                <strong>Game State:</strong> <span id="game-state">-</span>
              </div>
            </div>
          </div>
        </div>

        <div id="game-over" style="display: none">
          <div class="text-center">
            <h2 class="text-white mb-4">Game Over!</h2>
            <div class="card">
              <div class="card-body">
                <h4 id="winner-text">Player X wins!</h4>
                <button class="btn btn-danger btn-lg" onclick="resetGame()">
                  <i class="fas fa-redo me-2"></i>Play Again
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let currentGameId = null;
  let selectedCards = [];
  let currentPlayerHand = [];
  let isHuman = true;

  function startGame() {
    const playerCount = document.getElementById("playerCount").value;
    isHuman = document.getElementById("humanToggle").checked;

    fetch("/api/start_game", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        n_players: parseInt(playerCount),
        human: isHuman,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Start game response:", data);
        currentGameId = data.game_id;

        // Hide the start game section
        const startGameSection = document.querySelector(".full-width-section");
        if (startGameSection) {
          startGameSection.style.display = "none";
        }

        // Show the game interface
        document.getElementById("game-interface").style.display = "block";
        updateGameState(data.game_state);

        // If the game starts with an AI player, trigger AI turns
        const currentPlayer =
          data.game_state.players[data.game_state.current_player];
        const isHumanTurn = currentPlayer && currentPlayer.is_human;
        if (!isHumanTurn) {
          console.log(
            "DEBUG: Game started with AI player, triggering AI turns"
          );
          setTimeout(() => {
            triggerAITurns();
          }, 1000);
        }
      })
      .catch((error) => {
        console.error("Error starting game:", error);
        alert("Failed to start game");
      });
  }

  function updateGameState(gameState) {
    console.log("Updating game state:", gameState);

    // Update game info
    document.getElementById("current-player-id").textContent =
      gameState.current_player;
    document.getElementById("deck-count").textContent = gameState.deck_size;
    document.getElementById("game-state").textContent =
      gameState.game_state || "playing";
    document.getElementById("passes-count").textContent = gameState.passes || 0;

    // Update game status to show whose turn it is
    let statusText = "Game in progress...";
    if (gameState.current_player === 0) {
      statusText = "Your turn!";
    } else {
      statusText = `Player ${gameState.current_player}'s turn`;
    }
    document.getElementById("game-status").textContent = statusText;

    // Update other players
    updateOtherPlayers(gameState.players, gameState.current_player);

    // Update play area with current play
    updatePlayArea(gameState.current_play, gameState.last_action);

    // Show hand if present and player is human
    if (gameState.hand) {
      displayHand(gameState.hand);
    }

    // Check for game end
    if (gameState.winner !== null) {
      document.getElementById("game-controls").innerHTML = `
        <div class="alert alert-success">
          <h4>Game Over!</h4>
          <p>Player ${gameState.winner} wins!</p>
          <button class="btn btn-primary" onclick="resetGame()">New Game</button>
        </div>
      `;
    }
  }

  function updateOtherPlayers(players, currentPlayer) {
    const container = document.getElementById("other-players");
    container.innerHTML = "";

    players.forEach((player, index) => {
      if (index === 0) return; // Skip current player

      const playerDiv = document.createElement("div");
      playerDiv.className = `player-area ${
        index === currentPlayer ? "current-player" : ""
      }`;

      // Create card backs
      const cardBacks = [];
      for (let i = 0; i < player.hand_size; i++) {
        cardBacks.push('<div class="card card-back"></div>');
      }

      playerDiv.innerHTML = `
      <h6 class="player-info">Player ${player.id} (${
        player.hand_size
      } cards)</h6>
      <div class="card-back-container">
        ${cardBacks.join("")}
      </div>
    `;
      container.appendChild(playerDiv);
    });
  }

  function updatePlayArea(currentPlay, lastAction) {
    const playArea = document.getElementById("play-area");

    if (!currentPlay && !lastAction) {
      playArea.innerHTML = '<div class="text-white">No cards played yet</div>';
      return;
    }

    // Show round end message
    if (lastAction && lastAction.action === "round_end") {
      playArea.innerHTML = `
        <div class="text-white mb-2" style="font-size: 1.2em; font-weight: bold; color: #ffc107;">
          ${lastAction.message}
        </div>
      `;
      return;
    }

    // Show current highest play
    if (currentPlay) {
      const cardsHtml = currentPlay
        .map((card) => createCardElement(card))
        .join("");
      playArea.innerHTML = `
        <div class="text-white mb-2">Current highest play:</div>
        <div>${cardsHtml}</div>
      `;
      return;
    }

    // Show last action (for passes or when no current play)
    if (lastAction) {
      if (lastAction.action === "pass") {
        playArea.innerHTML = `
          <div class="text-white mb-2" style="font-size: 1.1em; color: #ffc107;">
            <i class="fas fa-times-circle me-2"></i>Player ${lastAction.player_id} passed
          </div>
        `;
      } else if (lastAction.cards) {
        const cardsHtml = lastAction.cards
          .map((card) => createCardElement(card))
          .join("");
        playArea.innerHTML = `
        <div class="text-white mb-2">Player ${lastAction.player_id} played:</div>
        <div class="ai-play">${cardsHtml}</div>
      `;
      }
    }
  }

  function createCardElement(card) {
    const rank = card.slice(0, -1);
    const suit = card.slice(-1);
    const suitSymbol = getSuitSymbol(suit);
    const suitClass = getSuitClass(suit);

    return `<div class="card ${suitClass}">${rank}${suitSymbol}</div>`;
  }

  function getSuitSymbol(suit) {
    const symbols = {
      H: "♥",
      D: "♦",
      C: "♣",
      S: "♠",
    };
    return symbols[suit] || suit;
  }

  function getSuitClass(suit) {
    const classes = {
      H: "hearts",
      D: "diamonds",
      C: "clubs",
      S: "spades",
    };
    return classes[suit] || "";
  }

  function playCards() {
    const selectedCards = getSelectedCards();
    const gameId = getGameId();

    fetch("/play", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        game_id: gameId,
        cards: selectedCards,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          alert("Error: " + data.error);
          return;
        }
        updateGameState(data);
        clearSelection();
        // Add delay to show the play, then trigger AI turns
        setTimeout(() => {
          triggerAITurns();
        }, 1000);
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error playing cards");
      });
  }

  function passTurn() {
    const gameId = getGameId();

    fetch("/play", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        game_id: gameId,
        cards: [], // Empty array means pass
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          alert("Error: " + data.error);
          return;
        }
        updateGameState(data);
        // Add delay to show the pass, then trigger AI turns
        setTimeout(() => {
          triggerAITurns();
        }, 1000);
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error passing turn");
      });
  }

  function triggerAITurns() {
    const gameId = getGameId();
    console.log("DEBUG: triggerAITurns called");

    // Keep triggering AI turns until it's the human player's turn
    function processAITurn() {
      console.log("DEBUG: processAITurn called");
      fetch("/api/ai_turn/" + gameId)
        .then((response) => response.json())
        .then((data) => {
          console.log("DEBUG: AI turn response:", data);
          if (data.error) {
            console.error("Error getting game state:", data.error);
            return;
          }

          updateGameState(data);

          // If game is finished, stop
          if (data.game_state === "finished") {
            console.log("DEBUG: Game finished, stopping AI turns");
            return;
          }

          // Check if current player is human
          const currentPlayer = data.players[data.current_player];
          const isHumanTurn = currentPlayer && currentPlayer.is_human;
          console.log(
            "DEBUG: Current player:",
            data.current_player,
            "Is human:",
            isHumanTurn
          );

          // If it's still not the human player's turn, continue AI turns with delay
          if (!isHumanTurn) {
            console.log("DEBUG: Continuing AI turns, next turn in 1 second");
            setTimeout(processAITurn, 1000); // 1 second delay between AI turns
          } else {
            console.log("DEBUG: Human turn reached, stopping AI turns");
          }
        })
        .catch((error) => {
          console.error("Error in AI turn:", error);
        });
    }

    // Start AI turns if it's not the human player's turn
    fetch("/api/game_state/" + gameId)
      .then((response) => response.json())
      .then((data) => {
        console.log("DEBUG: Initial game state:", data);
        // Check if current player is human
        const currentPlayer = data.players[data.current_player];
        const isHumanTurn = currentPlayer && currentPlayer.is_human;
        console.log(
          "DEBUG: Initial check - Current player:",
          data.current_player,
          "Is human:",
          isHumanTurn
        );

        if (!isHumanTurn) {
          console.log("DEBUG: Starting AI turns");
          processAITurn();
        } else {
          console.log("DEBUG: Already human turn, no AI turns needed");
        }
      })
      .catch((error) => {
        console.error("Error checking game state:", error);
      });
  }

  function resetGame() {
    currentGameId = null;
    selectedCards = [];

    // Hide game interface and game over sections
    document.getElementById("game-over").style.display = "none";
    document.getElementById("game-interface").style.display = "none";

    // Clear any game state displays
    document.getElementById("play-area").innerHTML =
      '<div class="text-white">Play area - cards will appear here</div>';
    document.getElementById("player-hand").innerHTML = "";
    document.getElementById("other-players").innerHTML = "";

    // Reset game info displays
    document.getElementById("current-player-id").textContent = "-";
    document.getElementById("deck-count").textContent = "0";
    document.getElementById("game-state").textContent = "-";
    document.getElementById("passes-count").textContent = "0";
    document.getElementById("game-status").textContent = "Game in progress...";

    // Show the start game section (it should be visible by default, but ensure it's shown)
    const startGameSection = document.querySelector(".full-width-section");
    if (startGameSection) {
      startGameSection.style.display = "block";
    }
  }

  function getSelectedCards() {
    const selectedCards = [];
    document.querySelectorAll(".card.selected").forEach((card) => {
      selectedCards.push(card.dataset.card);
    });
    return selectedCards;
  }

  function getGameId() {
    return currentGameId;
  }

  function clearSelection() {
    document.querySelectorAll(".card.selected").forEach((card) => {
      card.classList.remove("selected");
    });
  }

  function displayHand(hand) {
    const handContainer = document.getElementById("player-hand");
    if (!hand || hand.length === 0) {
      handContainer.innerHTML =
        '<div class="text-muted">No cards in hand</div>';
      return;
    }

    handContainer.innerHTML = "";
    currentPlayerHand = hand;

    hand.forEach((card) => {
      const cardDiv = document.createElement("div");
      cardDiv.className = "card " + getSuitClass(card.slice(-1));
      cardDiv.textContent = card.slice(0, -1) + getSuitSymbol(card.slice(-1));
      cardDiv.dataset.card = card;
      cardDiv.onclick = function () {
        if (cardDiv.classList.contains("selected")) {
          cardDiv.classList.remove("selected");
          selectedCards = selectedCards.filter((c) => c !== card);
        } else {
          cardDiv.classList.add("selected");
          selectedCards.push(card);
        }
      };
      if (selectedCards.includes(card)) cardDiv.classList.add("selected");
      handContainer.appendChild(cardDiv);
    });
  }

  // Auto-refresh game state every 3 seconds
  setInterval(() => {
    if (currentGameId) {
      fetch("/api/game_state/" + currentGameId)
        .then((response) => response.json())
        .then((data) => {
          updateGameState(data);
        })
        .catch((error) => {
          console.error("Error updating game state:", error);
        });
    }
  }, 3000);
</script>
{% endblock %}
